{"version":3,"file":"Bus.js","names":["Bus","Component","genId","ref","glBusRootNode","dependents","forEach","d","redraw","componentDidMount","uniform","index","props","glParent","context","invariant","Node","_addUniformBus","componentWillUnmount","_removeUniformBus","componentDidUpdate","oldUniform","oldIndex","getChildContext","_addGLNodeChild","node","glNode","_removeGLNodeChild","_addDependent","i","indexOf","invariantNoDependentsLoop","push","_removeDependent","splice","getGLRenderableNode","getGLRenderableContent","mapRenderableContent","glSurface","getGLName","String","getGLShortName","content","shortContentName","constructor","name","capture","x","y","w","h","_onContextLost","_onContextRestored","gl","render","children","RenderLessElement","onRef","undefined","PropTypes","object","isRequired"],"sources":["../src/Bus.js"],"sourcesContent":["//@flow\nimport invariant from \"invariant\";\nimport React, { Component } from \"react\";\nimport PropTypes from \"prop-types\";\nimport Node from \"./Node\";\nimport invariantNoDependentsLoop from \"./helpers/invariantNoDependentsLoop\";\nimport genId from \"./genId\";\n\nimport type { Surface } from \"./createSurface\";\nimport type { NDArray } from \"ndarray\";\n\ntype Props = {|\n  children?: React$Element<*> | ((redraw?: () => void) => React$Element<*>),\n  uniform?: string,\n  index: number,\n|};\n\n/**\n * a **Bus is a container to \"cache\" and re-use content** (tree of Node, canvas, video,...) somewhere else in your GL graph.\n * To use it, use the Bus `ref`:\n * - provide it in another Node texture uniform so you can share computation (send a Node texture to multiple Nodes dependent) (more exactly, a working pattern is to give a `()=>ref` function that will be resolved in `DidUpdate` lifecycle)\n * - You have a `capture()` method to snapshot the underlying Node (because Node can be hidden being nested React components).\n *\n *\n * @prop {any} children the content to render. It can also be a function that takes a redraw function and render an element.\n * @prop {string} [uniform] In case you want to explicitely draw Bus directly into a uniform, you can give the uniform name of the parent node.\n * If this prop is not used, the Bus does not directly belong to a Node and a ref can be used to indirectly give a texture to a node.\n * `uniform` is equivalent to directly pass your VDOM inside the Node uniforms prop.\n *\n * **Usage Example**\n *\n * [![](https://github.com/ProjectSeptemberInc/gl-react/raw/master/docs/examples/blur.gif)](/blurmapmouse)\n *\n * @example\n *\n * <Surface ...>\n *   <Bus ref=\"myBus\">\n *     //here, glEffects or content like a canvas/video...\n *   </Bus>\n *   <Node uniforms={{\n *     texture: () => this.refs.myBus\n *   }} ... />\n * </Surface>\n *\n */\nexport default class Bus extends Component<Props, *> {\n  id: number = genId();\n  context: {\n    glParent: Surface | Node,\n    glSurface: Surface,\n  };\n  dependents: Array<Node | Surface> = [];\n\n  static defaultProps = {\n    index: 0,\n  };\n\n  static contextTypes = {\n    glParent: PropTypes.object.isRequired,\n    glSurface: PropTypes.object.isRequired,\n  };\n\n  static childContextTypes = {\n    glParent: PropTypes.object.isRequired,\n  };\n\n  componentDidMount() {\n    const { uniform, index } = this.props;\n    if (uniform) {\n      const { glParent } = this.context;\n      invariant(\n        glParent instanceof Node,\n        'a <Bus uniform=\"..\" /> needs to be inside a Node'\n      );\n      glParent._addUniformBus(this, uniform, index);\n    }\n    this.redraw();\n  }\n\n  componentWillUnmount() {\n    const { uniform, index } = this.props;\n    if (uniform) {\n      const { glParent } = this.context;\n      invariant(\n        glParent instanceof Node,\n        'a <Bus uniform=\"..\" /> needs to be inside a Node'\n      );\n      glParent._removeUniformBus(this, uniform, index);\n    }\n  }\n\n  componentDidUpdate({ uniform: oldUniform, index: oldIndex }: *) {\n    const { uniform, index } = this.props;\n    if (uniform && (uniform !== oldUniform || index !== oldIndex)) {\n      const { glParent } = this.context;\n      invariant(\n        glParent instanceof Node,\n        'a <Bus uniform=\"..\" /> needs to be inside a Node'\n      );\n      if (oldUniform) glParent._removeUniformBus(this, oldUniform, oldIndex);\n      glParent._addUniformBus(this, uniform, index);\n    }\n    this.redraw();\n  }\n\n  getChildContext(): { glParent: Bus } {\n    return {\n      glParent: this,\n    };\n  }\n\n  glNode: ?Node = null;\n  _addGLNodeChild(node: Node) {\n    this.glNode = node;\n    this.context.glParent.redraw();\n  }\n  _removeGLNodeChild(node: Node) {\n    this.glNode = null;\n  }\n\n  _addDependent(node: Node | Surface) {\n    const i = this.dependents.indexOf(node);\n    if (i === -1) {\n      invariantNoDependentsLoop(this, node);\n      this.dependents.push(node);\n    }\n  }\n\n  _removeDependent(node: Node | Surface) {\n    const i = this.dependents.indexOf(node);\n    if (i !== -1) this.dependents.splice(i, 1);\n  }\n\n  getGLRenderableNode(): ?Node {\n    return this.glNode;\n  }\n\n  getGLRenderableContent(): mixed {\n    const { mapRenderableContent } = this.context.glSurface;\n    const { glBusRootNode } = this;\n    return glBusRootNode && mapRenderableContent\n      ? mapRenderableContent(glBusRootNode)\n      : null;\n  }\n\n  getGLName(): string {\n    return `Bus(${\n      this.glNode\n        ? this.glNode.getGLName()\n        : String(this.getGLRenderableContent())\n    })`;\n  }\n\n  getGLShortName(): string {\n    const content = this.getGLRenderableContent();\n    const shortContentName = String(\n      (content && content.constructor && content.constructor.name) || content\n    );\n    return `Bus(${\n      this.glNode ? this.glNode.getGLShortName() : shortContentName\n    })`;\n  }\n\n  /**\n   * Capture the underlying Node pixels.\n   * NB it only works for nodes, not for content like video/canvas.\n   */\n  capture(x?: number, y?: number, w?: number, h?: number): NDArray {\n    invariant(this.glNode, \"Bus does not contain any Node\");\n    return this.glNode.capture(x, y, w, h);\n  }\n\n  glBusRootNode: ?mixed;\n  onRef = (ref: mixed) => {\n    this.glBusRootNode = ref;\n  };\n\n  /**\n   * Schedule a redraw of all nodes that depends on this Bus.\n   *\n   * @function\n   */\n  redraw = () => {\n    this.dependents.forEach((d) => d.redraw());\n  };\n\n  _onContextLost() {\n    const { glNode } = this;\n    if (glNode) glNode._onContextLost();\n  }\n\n  _onContextRestored(gl: WebGLRenderingContext) {\n    const { glNode } = this;\n    if (glNode) glNode._onContextRestored(gl);\n  }\n\n  _draw = () => {\n    // FIXME: _draw() on a Bus? (would a third party need this?)\n  };\n\n  render() {\n    const { children } = this.props;\n    const {\n      glSurface: { RenderLessElement, mapRenderableContent },\n    } = this.context;\n    return (\n      <RenderLessElement ref={mapRenderableContent ? this.onRef : undefined}>\n        {typeof children === \"function\" ? children(this.redraw) : children}\n      </RenderLessElement>\n    );\n  }\n}\n"],"mappings":"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"}