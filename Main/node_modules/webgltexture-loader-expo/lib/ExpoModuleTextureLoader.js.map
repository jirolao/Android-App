{"version":3,"file":"ExpoModuleTextureLoader.js","names":["neverEnding","Promise","hash","module","uri","localAsset","asset","Asset","fromModule","downloadAsync","then","remoteAssetCache","remoteAsset","i","lastIndexOf","ext","slice","key","md5","resolve","promise","all","success","failure","Image","getSize","width","height","FileSystem","documentDirectory","cache","size","localUri","localFile","loadAsset","startsWith","ExpoModuleTextureLoader","WebGLTextureLoaderAsyncHashCache","WeakMap","canLoad","input","inputHash","loadNoCache","gl","disposed","dispose","texture","createTexture","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","globalRegistry","add"],"sources":["../src/ExpoModuleTextureLoader.js"],"sourcesContent":["//@flow\nimport {\n  globalRegistry,\n  WebGLTextureLoaderAsyncHashCache\n} from \"webgltexture-loader\";\nimport { Image } from \"react-native\";\nimport * as FileSystem from \"expo-file-system\";\nimport { Asset } from \"expo-asset\";\n\nimport md5 from \"./md5\";\n\nconst neverEnding = new Promise(() => {});\n\ntype AssetModel = {\n  width: number,\n  height: number,\n  uri: string,\n  localUri: string\n};\n\nconst hash = (module: number | { uri: string }) =>\n  typeof module === \"number\" ? module : module.uri;\n\nconst localAsset = (module: number) => {\n  const asset = Asset.fromModule(module);\n  return asset.downloadAsync().then(() => asset);\n};\n\nconst remoteAssetCache = {};\n\nconst remoteAsset = (uri: string) => {\n  const i = uri.lastIndexOf(\".\");\n  const ext = i !== -1 ? uri.slice(i) : \".jpg\";\n  const key = md5(uri);\n  if (key in remoteAssetCache) {\n    return Promise.resolve(remoteAssetCache[key]);\n  }\n  const promise = Promise.all([\n    new Promise((success, failure) =>\n      Image.getSize(uri, (width, height) => success({ width, height }), failure)\n    ),\n    FileSystem.downloadAsync(\n      uri,\n      FileSystem.documentDirectory + `ExponentAsset-${key}${ext}`,\n      {\n        cache: true\n      }\n    )\n  ]).then(([size, asset]) => ({ ...size, uri, localUri: asset.uri }));\n  remoteAssetCache[key] = promise;\n  return promise;\n};\n\nconst localFile = (uri: string) => {\n  const i = uri.lastIndexOf(\".\");\n  const ext = i !== -1 ? uri.slice(i) : \".jpg\";\n  const key = md5(uri);\n  if (key in remoteAssetCache) {\n    return Promise.resolve(remoteAssetCache[key]);\n  }\n  const promise = new Promise((success, failure) =>\n    Image.getSize(uri, (width, height) => success({ width, height }), failure)\n  ).then(size => ({ ...size, uri, localUri: uri }));\n  remoteAssetCache[key] = promise;\n  return promise;\n};\n\nexport const loadAsset = (\n  module: number | { uri: string }\n): Promise<AssetModel> =>\n  typeof module === \"number\"\n    ? localAsset(module)\n    : module.uri.startsWith(\"file:\") ||\n      module.uri.startsWith(\"data:\") ||\n      module.uri.startsWith(\"asset:\") || // All local paths in Android Expo standalone app\n      module.uri.startsWith(\"assets-library:\") || // CameraRoll.getPhotos iOS\n      module.uri.startsWith(\"content:\") || // CameraRoll.getPhotos Android\n      module.uri.startsWith(\"/\") // Expo.takeSnapshotAsync in DEV in Expo 31\n    ? localFile(module.uri)\n    : remoteAsset(module.uri);\n\nclass ExpoModuleTextureLoader extends WebGLTextureLoaderAsyncHashCache<\n  number | { uri: string }\n> {\n  objIds: WeakMap<WebGLTexture, number> = new WeakMap();\n\n  canLoad(input: any) {\n    return (\n      typeof input === \"number\" ||\n      (input && typeof input === \"object\" && typeof input.uri === \"string\")\n    );\n  }\n\n  inputHash(module: *) {\n    return typeof module === \"number\" ? module : module.uri;\n  }\n\n  loadNoCache(module: *) {\n    const { gl } = this;\n    let disposed = false;\n    const dispose = () => {\n      disposed = true;\n    };\n    const promise = loadAsset(module).then(asset => {\n      if (disposed) return neverEnding;\n      const { width, height } = asset;\n      const texture = gl.createTexture();\n      gl.bindTexture(gl.TEXTURE_2D, texture);\n      // $FlowFixMe\n      gl.texImage2D(\n        gl.TEXTURE_2D,\n        0,\n        gl.RGBA,\n        width,\n        height,\n        0,\n        gl.RGBA,\n        gl.UNSIGNED_BYTE,\n        asset\n      );\n      return { texture, width, height };\n    });\n    return { promise, dispose };\n  }\n}\n\nglobalRegistry.add(ExpoModuleTextureLoader);\n\nexport default ExpoModuleTextureLoader;\n"],"mappings":"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"}